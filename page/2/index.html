<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="sizeoftank">
<meta property="og:url" content="http://sizeoftank.github.io/page/2/index.html">
<meta property="og:site_name" content="sizeoftank">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sizeoftank">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://sizeoftank.github.io/page/2/">





  <title>sizeoftank</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">sizeoftank</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2014/07/18/2014/2014-07-18-python-extent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/07/18/2014/2014-07-18-python-extent/" itemprop="url">使用C/C++对Python进行扩展</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-07-18T16:52:41+00:00">
                2014-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2014/07/18/2014/2014-07-18-python-extent/" class="leancloud_visitors" data-flag-title="使用C/C++对Python进行扩展">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Python是一门极其灵活和简洁的语言，但其执行效率并不理想，相反C/C++的写法相对来说就复杂多了，但是C/C++却有很好的执行效率。而Python提供了可扩展的底层API给编程人员，可以通过它编程实现功能后，给Python上层调用，这样就将Python的灵活性和C/C++的效率结合起来了~</p>
<p><strong>一些比较有用的资料</strong></p>
<p><a href="http://web.mit.edu/people/amliu/vrut/python/ext/intro.html%20" target="_blank" rel="noopener">http://web.mit.edu/people/amliu/vrut/python/ext/intro.html </a></p>
<p><a href="http://www.ibm.com/developerworks/cn/linux/l-pythc/#icomments%20" target="_blank" rel="noopener">http://www.ibm.com/developerworks/cn/linux/l-pythc/#icomments </a></p>
<p><a href="https://docs.python.org/2/c-api/index.html%20" target="_blank" rel="noopener">https://docs.python.org/2/c-api/index.html </a></p>
<p><strong>C/C++代码如何导出到Python</strong></p>
<ol>
<li><p><strong>加入Python的头文件</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;python2.7/Python.h&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>导出方法表和模块</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义模块的方法表，这边有两个例子函数</span></span><br><span class="line"><span class="comment">//get_args(): 获取Python中的参数并在终端打印</span></span><br><span class="line"><span class="comment">//isorder(): 判断一个Python的列表是否是升序排列的</span></span><br><span class="line"><span class="keyword">static</span> PyMethodDef PyDemoMethods[] = &#123;</span><br><span class="line">    &#123; <span class="string">"get_args"</span>, get_args, METH_VARARGS, <span class="string">"None."</span>&#125;,</span><br><span class="line">    &#123; <span class="string">"isorder"</span>, isorder, METH_VARARGS, <span class="string">"None."</span>&#125;,</span><br><span class="line">    &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译后会生成Python可以import的模块PyDemo</span></span><br><span class="line"><span class="function">PyMODINIT_FUNC <span class="title">initPyDemo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject *m = Py_InitModule(<span class="string">"PyDemo"</span>, PyDemoMethods);</span><br><span class="line">    <span class="keyword">if</span> (m == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>编译和链接</strong></p>
<p>C/C++ 的源码在Linux编译成.so文件给Python调用</p>
<p>g++ -shared -fpic pydemo.cpp -o PyDemo.so</p>
<p><strong>在C/C++中获取并打印Python的参数</strong></p>
<p>其中在C/C++中的函数都需要遵循这个函数原型进行扩展</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PyObject* <span class="title">get_args</span><span class="params">(PyObject *self, PyObject *args)</span></span></span><br></pre></td></tr></table></figure>
<p>其中PyObject是Python中的对象，Python是一门完全面向对象的语言，它的所有对象在C语言中都是以PyObject结构体来表现的</p>
<p>参数args提供了一个变长参数表给C/C++语言<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PyArg_ParseTuple(args, <span class="string">"ids"</span>, &amp;i, &amp;d, &amp;s)</span><br></pre></td></tr></table></figure></p>
<p>这行代码用来获取Python中的参数，”ids” 用来描述有三个参数，分别是整型(i)、双精度浮点数(d)和字符串(s)</p>
<p>其中C/C++语言的变量作为参数时需要加上取地址符&amp;</p>
<p>对于字符串类型，在C/C++中声明一个指针就行了，不需要对其分配空间，因为在参数解析后其会指向原先运行时数据所在的内存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PyObject* <span class="title">get_args</span><span class="params">(PyObject *self, PyObject *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">double</span> d;</span><br><span class="line">    <span class="keyword">char</span> *s;</span><br><span class="line">    <span class="keyword">if</span> (!PyArg_ParseTuple(args, <span class="string">"ids"</span>, &amp;i, &amp;d, &amp;s))&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; setiosflags(ios::fixed) &lt;&lt; setprecision(<span class="number">2</span>) &lt;&lt; d &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; s &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    Py_INCREF(Py_None);</span><br><span class="line">    <span class="keyword">return</span> Py_None;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>判断一个Python列表是否升序</strong></p>
<p>上面一个例子只是简单的获取参数并打印，现在看下如何对Pyhton中的List对象进行操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PyObject* <span class="title">isorder</span><span class="params">(PyObject *self, PyObject *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject* pList = <span class="literal">NULL</span>;  <span class="comment">//声明一个对象指针</span></span><br><span class="line">    Py_ssize_t i;            <span class="comment">//下标i需要用这个结构体进行定义</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!PyArg_ParseTuple(args, <span class="string">"O"</span>, &amp;pList))&#123; <span class="comment">//Python中的参数作为对象传入("O")</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!PyList_Check(pList))</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历列表比较相邻对象</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; PyList_Size(pList); i++)&#123;</span><br><span class="line">    	<span class="keyword">if</span> (PyObject_Compare(PyList_GetItem(pList, i<span class="number">-1</span>), PyList_GetItem(pList, i)) != <span class="number">-1</span>)&#123;</span><br><span class="line">    		Py_INCREF(Py_False);</span><br><span class="line">    		<span class="keyword">return</span> Py_False;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Py_INCREF(Py_True);</span><br><span class="line">    <span class="keyword">return</span> Py_True;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中上面两个例子返回None和布尔对象时都用了Py_INCREF这个宏~</p>
<p>是Python内部对于这些对象有引用计数的机制，在使用这些对象进行返回时，就需要使用这个宏更新它的计数</p>
<p><strong>六、在Python中调用:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PyDemo</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    print(PyDemo.get_args(<span class="number">1</span>, <span class="number">4.7</span>, <span class="string">"hello"</span>))</span><br><span class="line">    l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>]</span><br><span class="line">    print(PyDemo.isorder(l))</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2014/06/29/2014/2014-06-29-python-htmlparse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/06/29/2014/2014-06-29-python-htmlparse/" itemprop="url">Python解析HTML网页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-06-29T12:30:38+00:00">
                2014-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2014/06/29/2014/2014-06-29-python-htmlparse/" class="leancloud_visitors" data-flag-title="Python解析HTML网页">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在写个爬虫程序，用到用到了标准库中的HTMLParser模块。</p>
<p><strong>一、示例程序：</strong></p>
<p>其实这个框架用起来非常简单：</p>
<p>在handle_starttag方法中编写代码对开始标记进行处理 <a href="http://localhost/public_html" target="_blank" rel="noopener"></a></p>
<p>在handle_endtag中编写代码对结束标记进行处理 </p>
<p>在handle_data中编写代码对中间的数据进行处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> HTMLParser <span class="keyword">import</span> HTMLParser</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoParser</span><span class="params">(HTMLParser)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></span><br><span class="line">    	HTMLParser.reset(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span><span class="params">(self, tag, attrs)</span>:</span></span><br><span class="line">    	<span class="keyword">print</span> tag, attrs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_endtag</span><span class="params">(self, tag)</span>:</span></span><br><span class="line">    	<span class="keyword">print</span> tag</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">    	<span class="keyword">print</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    html = <span class="string">'''</span></span><br><span class="line"><span class="string">        &lt;a href="http://localhost/public_html"&gt; Test &lt;/a&gt;</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">    p = DemoParser()</span><br><span class="line">    p.feed(html)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>
<p><strong> 二、将页面解析成标签树：</strong></p>
<p>这里说一下如何借助HTMLParser这个模块将网页解析成标签树的形式，实现的思路比较简单，就是创建一个节点类（HTMLNode)，记录标签(TAG)、属性(ATTRS)，数据(DATA)这些信息，更进一步地可以利用动态添加属性的机制，直接从ATTRS创建每个属性和相应的值</p>
<p>在节点类(HTMLNode)之中将树本身的相关的信息(孩子链表、深度、父节点等信息)定义成私有成员不允许外部直接访问，再实现相应的对树操作的方法，这样完成了对这个数据结构的封装。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTMLNode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tag , attrs, data=None, root=None, depth=<span class="number">0</span>)</span>:</span></span><br><span class="line">    	<span class="comment"># define children, depth, root as private.</span></span><br><span class="line">    	self.__children = []</span><br><span class="line">    	self.__depth = depth</span><br><span class="line">    	<span class="comment"># top node of a tree, set root refer to itself.</span></span><br><span class="line">    	<span class="comment"># otherwise, set root refer to it's parent.</span></span><br><span class="line">    	<span class="keyword">if</span> root == <span class="keyword">None</span>:</span><br><span class="line">    		self.__root = self</span><br><span class="line">    	<span class="keyword">else</span>:</span><br><span class="line">    		self.__root = root</span><br><span class="line">    	<span class="comment"># define tag, attrs, data as public.</span></span><br><span class="line">    	self.tag  = tag</span><br><span class="line">    	self.attrs = attrs</span><br><span class="line">    	self.data = data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lchild</span><span class="params">(self, i)</span>:</span></span><br><span class="line">    	<span class="comment"># index children list from left to right.</span></span><br><span class="line">    	<span class="keyword">if</span> len(self.__children) &gt; <span class="number">0</span>:</span><br><span class="line">    		<span class="keyword">return</span> self.__children[i]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rchild</span><span class="params">(self, i)</span>:</span></span><br><span class="line">    	<span class="comment"># index children list from right to left.</span></span><br><span class="line">    	<span class="keyword">if</span> len(self.__children) &gt; <span class="number">0</span>:</span><br><span class="line">    		n = len(self.__children)</span><br><span class="line">    		<span class="keyword">return</span> self.__children[n-i<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, node)</span>:</span></span><br><span class="line">    	<span class="comment"># add a node to children list.</span></span><br><span class="line">    	node.__root = self</span><br><span class="line">    	node.__depth = self.__depth + <span class="number">1</span></span><br><span class="line">    	self.__children.append(node)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parent</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.__root</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">num</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> len(self.__children)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">depth</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.__depth</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">trvs</span><span class="params">(self, visit_in_func, visit_out_func=None)</span>:</span></span><br><span class="line">    	visit_in_func(self)</span><br><span class="line">    	<span class="keyword">for</span> child <span class="keyword">in</span> self.__children:</span><br><span class="line">    		child.trvs(visit_in_func, visit_out_func)</span><br><span class="line">    	<span class="keyword">if</span> visit_out_func != <span class="keyword">None</span>:</span><br><span class="line">    		visit_out_func(self)</span><br><span class="line">    	<span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>其中 trvs()方法递归去访问节点和节点的子树，这边传入了两个函数，一个在进入时调用，一个在退出前调用，对HTML进行处理的时候具体去实现这两个函数对这颗标签树进行访问。</p>
<p>写个一个简单的测试代码，用于以增加缩进量的形式格式化输出HTML代码便于阅读（不过这边没有对内容进行转码，转换后的HTML文件再打开就不对了，只能用来阅读它的结构）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># visit_in and visit_out function use to test.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit_in</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> n.tag == <span class="keyword">None</span>: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> n!=<span class="keyword">None</span>:</span><br><span class="line">    	<span class="keyword">print</span> <span class="string">'%s&lt;%s '</span>%(<span class="string">'    '</span>*(n.depth()<span class="number">-1</span>),n.tag),</span><br><span class="line">    	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(n.attrs)):</span><br><span class="line">    		<span class="keyword">if</span> i == len(n.attrs)<span class="number">-1</span>:</span><br><span class="line">    			<span class="keyword">print</span> <span class="string">'%s=\"%s\"&gt;'</span>%(n.attrs[i][<span class="number">0</span>],n.attrs[i][<span class="number">1</span>]),</span><br><span class="line">    		<span class="keyword">else</span>:</span><br><span class="line">    			<span class="keyword">print</span> <span class="string">'%s=\"%s\" '</span>%(n.attrs[i][<span class="number">0</span>],n.attrs[i][<span class="number">1</span>]),</span><br><span class="line">    	<span class="keyword">if</span> n.data != <span class="keyword">None</span>:</span><br><span class="line">    		<span class="keyword">if</span> n.tag == <span class="string">'script'</span>:</span><br><span class="line">    			repr_code_lines = n.data.split(<span class="string">'\n'</span>)</span><br><span class="line">    			<span class="keyword">for</span> code_line <span class="keyword">in</span> repr_code_lines:</span><br><span class="line">    				<span class="keyword">print</span> <span class="string">'\n%s%s'</span>%(<span class="string">'    '</span>*(n.depth()), code_line),</span><br><span class="line">    			<span class="keyword">print</span></span><br><span class="line">    		<span class="keyword">else</span>:</span><br><span class="line">    			<span class="keyword">while</span> n.data.find(<span class="string">'  '</span>)!=<span class="number">-1</span>:</span><br><span class="line">    				n.data = n.data.replace(<span class="string">'  '</span>,<span class="string">' '</span>)</span><br><span class="line">    			n.data = n.data.replace(<span class="string">'\r\n'</span>, <span class="string">' '</span>)</span><br><span class="line">    			n.data = n.data.replace(<span class="string">'\n'</span>, <span class="string">' '</span>)</span><br><span class="line">    			n.data = n.data.replace(<span class="string">' '</span>, <span class="string">''</span>)</span><br><span class="line">    			n.data = n.data.replace(<span class="string">'\t\t'</span>,<span class="string">'\t'</span>)</span><br><span class="line">    			n.data = n.data.replace(<span class="string">'\t'</span>,<span class="string">''</span>)</span><br><span class="line">    			<span class="keyword">if</span> n.data != <span class="string">''</span>:</span><br><span class="line">    				<span class="keyword">print</span> <span class="string">'\n%s%s'</span>%(<span class="string">'    '</span>*(n.depth()),n.data)</span><br><span class="line">    	<span class="keyword">if</span> n.num() != <span class="number">0</span>:</span><br><span class="line">    		<span class="keyword">if</span> n.data == <span class="keyword">None</span>:</span><br><span class="line">    			<span class="keyword">print</span></span><br><span class="line">    		<span class="keyword">elif</span> n.data == <span class="string">''</span>:</span><br><span class="line">    			<span class="keyword">print</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit_out</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> n.tag == <span class="keyword">None</span>: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> n.num() != <span class="number">0</span> <span class="keyword">or</span> n.data != <span class="keyword">None</span>:</span><br><span class="line">    	<span class="keyword">print</span> <span class="string">'%s&lt;/%s&gt;'</span>%(<span class="string">'    '</span>*(n.depth()<span class="number">-1</span>), n.tag)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	<span class="keyword">print</span> <span class="string">'&lt;/%s&gt;'</span>%(n.tag)</span><br></pre></td></tr></table></figure>
<p>下面来看如何建立这棵树，算法比较简单，先创建一个根节点，然后定义一个pre对象保持始终引用当前节点的对象，如果遇到新的开始标记，就将该标记加入到孩子链表中，然后pre对象引用的是孩子链表中的最右边节点；如果遇到了结束标记，就将pre对象返回上层的父节点</p>
<p>编码的时候发现两个问题，一个是有一些标签可以不书写结束标记的，那么就需要特殊处理，否则会出错，我的解决方法时将这些标签定义成terminated(终结的)如果遇到这些标签时直接跳出返回上层节点；另一个是发现有些标签不匹配，这边是出现了多出了结束标记的情况，我的解决方法是用了个辅助堆栈进行检查，在处理结束标记时，先检查栈顶元素，如果栈顶元素作为开始标记不和当前结束标记匹配，就丢弃这个结束标记。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTMLTreeParser</span><span class="params">(HTMLParser)</span>:</span></span><br><span class="line">    terminated = ( <span class="string">'meta'</span>,<span class="string">'link'</span>,<span class="string">'br'</span>, <span class="string">'img'</span>, <span class="string">'input'</span>, <span class="string">'frame'</span>, <span class="string">'col'</span>, </span><br><span class="line">                    <span class="string">'hr'</span>, <span class="string">'base'</span>,<span class="string">'option'</span>, <span class="string">'area'</span>,<span class="string">'param'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></span><br><span class="line">    	HTMLParser.reset(self)</span><br><span class="line">    	self.tree = HTMLNode(<span class="keyword">None</span>,<span class="keyword">None</span>)</span><br><span class="line">    	self.pre = self.tree</span><br><span class="line">    	self.stack = []</span><br><span class="line">    	<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    def inc(self,key):</span></span><br><span class="line"><span class="string">    	for i in range(0, len(self.count)):</span></span><br><span class="line"><span class="string">    		if self.count[i][0] == key:</span></span><br><span class="line"><span class="string">    			self.count[i][1] = self.count[i][1] + 1</span></span><br><span class="line"><span class="string">    			return</span></span><br><span class="line"><span class="string">    	self.count.append([key, 1])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    def dec(self, key):</span></span><br><span class="line"><span class="string">    	for i in range(0, len(self.count)):</span></span><br><span class="line"><span class="string">    		if self.count[i][0] == key:</span></span><br><span class="line"><span class="string">    			self.count[i][1] = self.count[i][1] - 1</span></span><br><span class="line"><span class="string">    			return</span></span><br><span class="line"><span class="string">    	self.count.append([key, 0])</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span><span class="params">(self, tag, attrs)</span>:</span></span><br><span class="line">    	self.pre.add(HTMLNode(tag,attrs))</span><br><span class="line">    	self.pre = self.pre.rchild(<span class="number">0</span>)</span><br><span class="line">    	<span class="comment"># some terminated tags have not endtag &lt;/xx&gt;.</span></span><br><span class="line">    	<span class="keyword">if</span> tag <span class="keyword">in</span> HTMLTreeParser.terminated:</span><br><span class="line">    		self.pre = self.pre.parent()</span><br><span class="line">    	<span class="keyword">else</span>:</span><br><span class="line">    		self.stack.append(tag)</span><br><span class="line">    	<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_endtag</span><span class="params">(self, tag)</span>:</span></span><br><span class="line">    	<span class="keyword">if</span> tag <span class="keyword">in</span> HTMLTreeParser.terminated:</span><br><span class="line">    		<span class="keyword">return</span></span><br><span class="line">    	<span class="keyword">else</span>:</span><br><span class="line">    		<span class="comment"># use stack to check whether endtag match to starttag.</span></span><br><span class="line">    		<span class="keyword">if</span> len(self.stack) == <span class="number">0</span> <span class="keyword">or</span> self.stack[len(self.stack)<span class="number">-1</span>] != tag:</span><br><span class="line">    			<span class="keyword">return</span></span><br><span class="line">    		<span class="keyword">else</span>:</span><br><span class="line">    			self.stack.pop()</span><br><span class="line">    	self.pre = self.pre.parent()</span><br><span class="line">    	<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">    	self.pre.data = data</span><br><span class="line">    	<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_html</span><span class="params">(self, html)</span>:</span></span><br><span class="line">    	self.feed(html)</span><br><span class="line">    	<span class="keyword">return</span> self.tree</span><br></pre></td></tr></table></figure>
<p>测试的时候编写代码打开有道词典的页面：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    params = &#123;<span class="string">'keyfrom'</span>:<span class="string">'dict.index'</span>,<span class="string">'q'</span>: <span class="string">'test'</span>&#125;</span><br><span class="line">    url = <span class="string">'http://dict.youdao.com/search?'</span>+urllib.urlencode(params)</span><br><span class="line">    opener = urllib2.build_opener()</span><br><span class="line">    opener.addheaders = [(<span class="string">'User-Agent'</span>,</span><br><span class="line">        <span class="string">'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:31/0) Gecko/20100101 Firefox/31.0'</span>)]</span><br><span class="line">    f = opener.open(url)</span><br><span class="line">    html=f.read()</span><br><span class="line">    hp=HTMLTreeParser()</span><br><span class="line">    T=hp.parse_html(html)</span><br><span class="line">    T.trvs(visit_in, visit_out)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2014/04/24/2014/2014-04-24-ply-yacc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/04/24/2014/2014-04-24-ply-yacc/" itemprop="url">PLY(Python Lex-Yacc)：Yacc</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-04-24T04:46:53+00:00">
                2014-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2014/04/24/2014/2014-04-24-ply-yacc/" class="leancloud_visitors" data-flag-title="PLY(Python Lex-Yacc)：Yacc">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>简单说下Yacc部分的内容</p>
<p>预备知识： Lex部分的内容，编译原理的文法知识，先试着写上下文无关文法就好了</p>
<p>调试过程中写这两个函数：</p>
<ol>
<li><p>cat(P) 用来打印数据，这个不用多说，就是把 P[0] … P[n-1] 打印</p>
</li>
<li><p>carry(P) 则是用来传递数据，很简单：P[0] = P[1] + … + P[n-1]，</p>
</li>
</ol>
<p><strong>注意到：</strong></p>
<p><strong>上面的相加只是是字符串连接的形式，目的是传递到左边的P[0]使得递归解析继续</strong></p>
<p><strong>也可以说这边的目的只是通过TOKEN字符串来看这个yacc解析器的工作过程，而不做具体的语法分析！</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cat</span><span class="params">(P)</span>:</span></span><br><span class="line">    print(<span class="string">""" + P[0]) + """</span> ,(<span class="string">':'</span>),</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(P)):</span><br><span class="line">        print(P[i]),</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">carry</span><span class="params">(P)</span>:</span></span><br><span class="line">    P[<span class="number">0</span>] = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(P)):</span><br><span class="line">        P[<span class="number">0</span>] = P[<span class="number">0</span>] + P[i]</span><br><span class="line">    cat(P)</span><br><span class="line">    <span class="keyword">return</span> P</span><br></pre></td></tr></table></figure>
<p>后面写文法，首先Yacc会根据写好的文法生成一个Table，写的文法有问题这里就会报错如果只是写一个简单的上下文无关文法边注意下按照它去展开，必须是可终结的就可以正常解析了这边可终结的就是说展开后最末端的文法定义，就是我们在Lex里定义的Token那些东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语句列表：</span></span><br><span class="line"><span class="comment"># 由一个语句列表加一条语句 or 单独一条语句</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_statement_list</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' statement_list : LBRACE statement_list RBRACE</span></span><br><span class="line"><span class="string">                        | statement statement_list</span></span><br><span class="line"><span class="string">                        | statement '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 语句 : if语句 or 非if语句</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_statement</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' statement : if_else_statement</span></span><br><span class="line"><span class="string">                  | noif_statement '''</span></span><br><span class="line">    carry(p)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 非if语句：</span></span><br><span class="line"><span class="comment"># 赋值+分号 or 函数表达式+分号 or 分号</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_noif_statement</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' noif_statement : assignment SEMI</span></span><br><span class="line"><span class="string">                        | func_expression SEMI</span></span><br><span class="line"><span class="string">                        | SEMI '''</span></span><br><span class="line">    carry(p)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 后面这一些是if结构文法，注意要使他无歧义，注释不写了…</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_if_else_statement</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' if_else_statement : matched</span></span><br><span class="line"><span class="string">                          | unmached '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_statement_matched</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' matched : IF LPAREN boolean_expression RPAREN matched ELSE matched</span></span><br><span class="line"><span class="string">                | if_else_statement_clause'''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_statement_unmached</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' unmached : IF LPAREN boolean_expression RPAREN if_else_statement</span></span><br><span class="line"><span class="string">                  | IF LPAREN boolean_expression RPAREN matched ELSE unmached '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_if_else_statement_clause</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' if_else_statement_clause : noif_statement</span></span><br><span class="line"><span class="string">                                  | LBRACE statement_list RBRACE '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋值：标识符 (=, +=, –=, =, *=, %= ) 表达式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_statement_assignment</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' assignment : identifier EQUALS expression</span></span><br><span class="line"><span class="string">                    | identifier PLUSEQUAL expression</span></span><br><span class="line"><span class="string">                    | identifier MINUSEQUAL expression</span></span><br><span class="line"><span class="string">                    | identifier TIMESEQUAL expression</span></span><br><span class="line"><span class="string">                    | identifier DIVEQUAL expression</span></span><br><span class="line"><span class="string">                    | identifier MODEQUAL expression  '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表达式：(算术，布尔，函数) 表达式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_expression</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' expression : math_expression</span></span><br><span class="line"><span class="string">                    | boolean_expression</span></span><br><span class="line"><span class="string">                    | func_expression '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数学表达式：这部分考虑运算符优先级顺序~</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_math_expression</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' math_expression : math_expression PLUS math_expression_term</span></span><br><span class="line"><span class="string">                        | math_expression MINUS math_expression_term</span></span><br><span class="line"><span class="string">                        | math_expression_term</span></span><br><span class="line"><span class="string">                        '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_boolean_expression</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' boolean_expression : TRUE '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多项式中的项：由因子的乘除运算组成 or 一个单独的因子</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_math_expression_term</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' math_expression_term : math_expression_term TIMES math_expression_factor</span></span><br><span class="line"><span class="string">                              | math_expression_term DIVIDE math_expression_factor</span></span><br><span class="line"><span class="string">                              | math_expression_term MODULO math_expression_factor</span></span><br><span class="line"><span class="string">                              | math_expression_factor '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 因子：变量 or 常量 or 函数表达式 or 括号因子(在算术表达式左右加括号)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_math_expression_factor</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' math_expression_factor : identifier</span></span><br><span class="line"><span class="string">                                | constant</span></span><br><span class="line"><span class="string">                                | func_expression</span></span><br><span class="line"><span class="string">                                | LPAREN math_expression RPAREN'''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_func_expression</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' func_expression : func_expression_term LPAREN argument_list RPAREN '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_func_expression_term</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' func_expression_term : func_expression PERIOD identifier</span></span><br><span class="line"><span class="string">                              | identifier '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_argument_list</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' argument_list : argument_list COMMA argument_term</span></span><br><span class="line"><span class="string">                      | argument_term '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_argument_term</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' argument_term : func_expression</span></span><br><span class="line"><span class="string">                      | math_expression</span></span><br><span class="line"><span class="string">                      | assignment</span></span><br><span class="line"><span class="string">                      | identifier</span></span><br><span class="line"><span class="string">                      | constant '''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_constant</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">'''constant : DECCONST</span></span><br><span class="line"><span class="string">              | FLOATCONST</span></span><br><span class="line"><span class="string">              | CHARCONST</span></span><br><span class="line"><span class="string">              | STRINGCONST'''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_identifier</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">''' identifier : ID'''</span></span><br><span class="line">    carry(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_empty</span><span class="params">(p)</span>:</span></span><br><span class="line">    <span class="string">'empty : '</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>然后是Yacc的用法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### test for yacc</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">yacc_test</span><span class="params">()</span>:</span></span><br><span class="line">    lx = lex.lex()</span><br><span class="line">    fp = open(sys.argv[<span class="number">1</span>])</span><br><span class="line">    codes = fp.read()</span><br><span class="line">    fp.close()</span><br><span class="line">    parser = yacc.yacc(debug=<span class="keyword">True</span>,debuglog=log)</span><br><span class="line">    parser.parse(codes)</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2014/03/24/2014/2014-03-24-ply-lex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/03/24/2014/2014-03-24-ply-lex/" itemprop="url">PLY(Python Lex-Yacc)：Lex部分</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-03-24T16:01:51+00:00">
                2014-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2014/03/24/2014/2014-03-24-ply-lex/" class="leancloud_visitors" data-flag-title="PLY(Python Lex-Yacc)：Lex部分">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>官方文档： <a href="http://www.dabeaz.com/ply/ply.html#ply_nn3" target="_blank" rel="noopener">http://www.dabeaz.com/ply/ply.html#ply_nn3</a></p>
<p>Lex: 一个词法分析器的生成器</p>
<p>完成一个从代码到LexToken流的转换</p>
<ol>
<li>定义词法规则</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">tokens = keywords + [</span><br><span class="line">        <span class="comment"># Literals (identifier, integer constant, float constant, string constant, char const)</span></span><br><span class="line">        <span class="string">'ID'</span>, <span class="string">'DECCONST'</span>, <span class="string">'HEXCONST'</span>, <span class="string">'FLOATCONST'</span>, <span class="string">'STRINGCONST'</span>, <span class="string">'CHARCONST'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Operators (+,-,*,/,%,|,&amp;,~,^,&lt;&lt;,&gt;&gt;, ||, &amp;&amp;, !, &lt;, &lt;=, &gt;, &gt;=, ==, !=)</span></span><br><span class="line">        <span class="string">'PLUS'</span>, <span class="string">'MINUS'</span>, <span class="string">'TIMES'</span>, <span class="string">'DIVIDE'</span>, <span class="string">'MOD'</span>,</span><br><span class="line">        <span class="string">'OR'</span>, <span class="string">'AND'</span>, <span class="string">'NOT'</span>, <span class="string">'XOR'</span>, <span class="string">'LSHIFT'</span>, <span class="string">'RSHIFT'</span>,</span><br><span class="line">        <span class="string">'LOR'</span>, <span class="string">'LAND'</span>, <span class="string">'LNOT'</span>,</span><br><span class="line">        <span class="string">'LT'</span>, <span class="string">'LE'</span>, <span class="string">'GT'</span>, <span class="string">'GE'</span>, <span class="string">'EQ'</span>, <span class="string">'NE'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assignment (=, *=, /=, %=, +=, -=, &lt;&lt;=, &gt;&gt;=, &amp;=, ^=, |=)</span></span><br><span class="line">        <span class="string">'EQUALS'</span>, <span class="string">'TIMESEQUAL'</span>, <span class="string">'DIVEQUAL'</span>, <span class="string">'MODEQUAL'</span>, <span class="string">'PLUSEQUAL'</span>, <span class="string">'MINUSEQUAL'</span>,</span><br><span class="line">        <span class="string">'LSHIFTEQUAL'</span>,<span class="string">'RSHIFTEQUAL'</span>, <span class="string">'ANDEQUAL'</span>, <span class="string">'XOREQUAL'</span>, <span class="string">'OREQUAL'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Increment/decrement (++,--)</span></span><br><span class="line">        <span class="string">'INCREMENT'</span>, <span class="string">'DECREMENT'</span>, <span class="string">'MODULO'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Structure dereference (-&gt;)</span></span><br><span class="line">        <span class="string">'ARROW'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Ternary operator (?)</span></span><br><span class="line">        <span class="string">'TERNARY'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Delimeters ( ) [ ] &#123; &#125; , . ; :</span></span><br><span class="line">        <span class="string">'LPAREN'</span>, <span class="string">'RPAREN'</span>,</span><br><span class="line">        <span class="string">'LBRACKET'</span>, <span class="string">'RBRACKET'</span>,</span><br><span class="line">        <span class="string">'LBRACE'</span>, <span class="string">'RBRACE'</span>,</span><br><span class="line">        <span class="string">'COMMA'</span>, <span class="string">'PERIOD'</span>, <span class="string">'SEMI'</span>, <span class="string">'COLON'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="string">'ANNOTATION'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="string">'CPPCOMMENT'</span>, <span class="string">'COMMENT'</span>,</span><br><span class="line">        <span class="comment"># Ellipsis (...)</span></span><br><span class="line">        <span class="string">'ELLIPSIS'</span></span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<p>其中keywords是一个由保留字组成的一个集合，tokens则有keywords部门再加上词法规则对应的名称</p>
<ol start="2">
<li>定义规则</li>
</ol>
<p>对于tokens里面的每个名称，使用例如 t_name = r”…”  的方式使用正则表达式进行定义</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Integer literal</span></span><br><span class="line">t_DECCONST = <span class="string">r'[\dA-Fa-f]+([uU]|[lL]|[uU][lL]|[lL][uU])?'</span></span><br><span class="line">t_HEXCONST = <span class="string">r'(0[Xx])[\dA-Fa-f]+([uU]|[lL]|[uU][lL]|[lL][uU])?'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Floating literal</span></span><br><span class="line">t_FLOATCONST = <span class="string">r'((\d+)(\.\d+)(e(\+|-)?(\d+))? | (\d+)e(\+|-)?(\d+))([lL]|[fF])?'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># String literal</span></span><br><span class="line">t_STRINGCONST = <span class="string">r'\"([^\\\n]|(\\.))*?\"'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Character constant 'c' or L'c'</span></span><br><span class="line">t_CHARCONST = <span class="string">r'(L)?\'([^\\\n]|(\\.))*?\''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Identifiers, and map to keywords</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">t_ID</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="string">r'[A-Za-z_][A-Za-z0-9_]*'</span>  </span><br><span class="line">    t.type = keywords_map.get(t.value, <span class="string">"ID"</span>)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"><span class="comment"># Comment (C-Style)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">t_COMMENT</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="string">r'/\*(.|\n)*?\*/'</span></span><br><span class="line">    t.lexer.lineno += t.value.count(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"><span class="comment"># Comment (C++-Style)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">t_CPPCOMMENT</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="string">r'//.*\n'</span></span><br><span class="line">    t.lexer.lineno += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">t_newline</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="string">r'\n+'</span></span><br><span class="line">    t.lexer.lineno += t.value.count(<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">t_error</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="comment">#print("Illegal character: '%s'" % t.value[0])</span></span><br><span class="line">    t.lexer.skip(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>有些需要特殊处理的部分用了def t_name() 这种函数来表示</p>
<p>比如:</p>
<p>在t_ID() 里面需要对标识符进行查找，来判断是否为保留字</p>
<p>在t_COMMENT() 里面需要跳过注释中的’\n’来加上相应的行号，使其以代码中的行号保持一致</p>
<p>另外有t_error() 来对词法错误进行处理…</p>
<p>测试代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lex_test</span><span class="params">()</span>:</span></span><br><span class="line">    lx = lex.lex()</span><br><span class="line">    fp = open(sys.argv[<span class="number">1</span>])</span><br><span class="line">    codes = fp.read()</span><br><span class="line">    fp.close()</span><br><span class="line">    lx.input(codes)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        tok = lx.token()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tok: <span class="keyword">break</span></span><br><span class="line">        print(tok)</span><br></pre></td></tr></table></figure>
<p>可以看到打印出的Tokens流了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2012/06/10/2012/2012-06-10-ipc-share-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2012/06/10/2012/2012-06-10-ipc-share-memory/" itemprop="url">进程间通信(IPC):共享内存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2012-06-10T01:42:13+00:00">
                2012-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/文章归档/" itemprop="url" rel="index">
                    <span itemprop="name">文章归档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2012/06/10/2012/2012-06-10-ipc-share-memory/" class="leancloud_visitors" data-flag-title="进程间通信(IPC):共享内存">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>共享内存就是允许两个或更多的进程可以访问一块共享的内存区域进行数据交换，是最快的IPC了。如果服务器端进程在共享内存区进行读写，就不允许客户端进程对共享内存进行访问了，这时候的IPC也就要对多个进程同步，使用信号量什么的来管理这一块共享区域了…</p>
<p>先来一个简单的应用：创建共享内存-&gt;映射共享内存 然后就可以进行读/写访问了…</p>
<p>头文件: sys/shm.h</p>
<p><strong>用来创建共享内存的函数：</strong></p>
<p>int shmget(key_t key,size_t size, int flag);</p>
<p>Returns: shared memory ID if OK, -1 on error.</p>
<p>如果成功则返回共享内存的ID</p>
<p><strong>用来映射共享内存的函数：</strong></p>
<p>void <em>shmat(int shmid, const void </em>addr, int flag);</p>
<p>Returns: pointer to shared memory segment if OK, -1 on error.</p>
<p>如果成功则返回一个指向共享内存区域的指针</p>
<p><strong>下面是一个简单的例程，通过命令行读取一个文件，执行fork后先由子进程读取文件中数据并写入共享内存中，子进程退出后，父进程从共享内存中读取数据输出到标准输出。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"apue.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_SIZE      40000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC_SIZE     40000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_SIZE        100000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHM_MODE        0600</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFSIZE        128</span></span><br><span class="line"><span class="keyword">char</span> <span class="built_in">array</span>[ARRAY_SIZE];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> shmid;</span><br><span class="line">        <span class="keyword">char</span> *ptr,*shmptr;</span><br><span class="line">        <span class="keyword">pid_t</span> pid;</span><br><span class="line">        <span class="keyword">char</span> writebuf[BUFFSIZE],readbuf[BUFFSIZE];</span><br><span class="line">        <span class="keyword">int</span> i,j,n;</span><br><span class="line">        <span class="keyword">int</span> fd;</span><br><span class="line">        <span class="keyword">char</span> *p,*q;</span><br><span class="line">        <span class="keyword">if</span> (argc!=<span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                perror(<span class="string">"usage: a.out filename"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"array[] from %lx to %lxn"</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;<span class="built_in">array</span>[<span class="number">0</span>],</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;<span class="built_in">array</span>[ARRAY_SIZE]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"statck around %lxn"</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>) &amp;shmid);  </span><br><span class="line">        <span class="comment">/* 分配堆空间 */</span></span><br><span class="line">        <span class="keyword">if</span> ((ptr = <span class="built_in">malloc</span>(MALLOC_SIZE))==<span class="literal">NULL</span>)</span><br><span class="line">                perror(<span class="string">"malloc error"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"malloced from %lx to %lxn"</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr+MALLOC_SIZE);</span><br><span class="line">        <span class="comment">/* 创建共享内存 */</span></span><br><span class="line">        <span class="keyword">if</span> ((shmid=shmget(IPC_PRIVATE,SHM_SIZE,SHM_MODE))&lt;<span class="number">0</span>)</span><br><span class="line">                perror(<span class="string">"shmget error"</span>);</span><br><span class="line">        <span class="comment">/* 映射共享内存 */</span></span><br><span class="line">        <span class="keyword">if</span> ((shmptr=shmat(shmid,<span class="number">0</span>,<span class="number">0</span>))==(<span class="keyword">void</span> *)<span class="number">-1</span>)</span><br><span class="line">                perror(<span class="string">"shmat error"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"shared memory attached from %lx to %lxn"</span>,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shmptr, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shmptr+SHM_SIZE);</span><br><span class="line">        <span class="keyword">if</span> ((pid=fork())&lt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                perror(<span class="string">"fork error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pid==<span class="number">0</span>)        <span class="comment">/* 子进程 */</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="comment">/* 向共享内存写数据后退出 */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"子进程向共享内存写数据...n"</span>);</span><br><span class="line">                <span class="keyword">if</span> ((fd=open(argv[<span class="number">1</span>],O_RDWR,<span class="number">0</span>))==<span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"不能打开文件:%sn"</span>,argv[<span class="number">1</span>]);</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                p = shmptr;</span><br><span class="line">                <span class="keyword">while</span> ((n=read(fd,readbuf,BUFFSIZE))&gt;<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                                *p++=readbuf[i];</span><br><span class="line">                &#125;</span><br><span class="line">                *p=<span class="number">-1</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"子进程写数据完毕n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">/* 父进程 */</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> (waitpid(pid,<span class="literal">NULL</span>,<span class="number">0</span>)!=pid)   <span class="comment">/* 等子进程退出 */</span></span><br><span class="line">                        perror(<span class="string">"waitpid error"</span>);</span><br><span class="line">                <span class="comment">/* 从共享内存中读数据 */</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"父进程读取数据...n"</span>);  </span><br><span class="line">                p = shmptr;</span><br><span class="line">                <span class="keyword">while</span> (*p!=EOF) <span class="built_in">printf</span>(<span class="string">"%c"</span>,*p++);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shmctl(shmid,IPC_RMID,<span class="number">0</span>)&lt;<span class="number">0</span>) <span class="comment">/* 移除共享内存 */</span></span><br><span class="line">                perror(<span class="string">"shmctl error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2012/06/08/2012/2012-06-08-ipc-fifo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2012/06/08/2012/2012-06-08-ipc-fifo/" itemprop="url">进程间通信(IPC): FIFO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2012-06-08T20:45:09+00:00">
                2012-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/文章归档/" itemprop="url" rel="index">
                    <span itemprop="name">文章归档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2012/06/08/2012/2012-06-08-ipc-fifo/" class="leancloud_visitors" data-flag-title="进程间通信(IPC): FIFO">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Linux/Unix下管道通信仅限与父子进程和兄弟进程之间，另外一种是FIFO（First In First Out，先进先出) 也叫有名管道是可以令两个没有关系的进程进行通信的，其实编程时把FIFO就当成是一种特殊的文件来处理就行了，先进先出的一端读数据一端写数据想必是很清楚，还有就是它是不能lseek函数的。</p>
<p><strong>一、创建FIFO文件的过程就类似创建文件的creat函数：</strong></p>
<p>int mkfifo(const char *pathname, mode_t mode);</p>
<p>/<em> Returns: 0 if OK, -1 on error </em>/</p>
<p>创建文件后，可以像打开普通文件一样使用open()函数打开FIFO文件，之后就可以使用read,write等函数来对这个文件进行操作了。</p>
<p><strong>二、关于打开文件时候的 O_NONBLOCK (非阻塞)选项：</strong></p>
<ol>
<li><p>在正常情况下(默认没有设置O_NONBLOCK选项)，以只读模式打开FIFO，也就是读进程中打开一个FIFO文件时，如果没有其他进程向FIFO写数据，那么读进程在执行open函数中就开始阻塞，直到有其他进程打开了FIFO写数据时，读进程中的open函数才返回。</p>
</li>
<li><p>在设置了O_NONBLOCK选项的情况，读进程在打开FIFO文件时立刻从open函数中返回并且可以开始从FIFO中读数据的操作。但是如果在读进程还没有准备好读数据时一个写进程以只写模式打开一个FIFO文件时，open函数返回-1，并且errno置为ENXIO。</p>
</li>
</ol>
<p>编程的时候就是先让读进程准备好从FIFO读取数据，然后写进程再朝FIFO写数据就行了。</p>
<p>fifo_read.c:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_MODE  (S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO <span class="meta-string">"myfifo"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFSIZE 128</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFFSIZE];</span><br><span class="line">    <span class="keyword">if</span> (mkfifo(FIFO,FILE_MODE)&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno==EEXIST)</span><br><span class="line">            perror(<span class="string">"FIFO 文件已经存在"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            perror(<span class="string">"创建FIFO文件错误"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((fd=open(FIFO,O_RDONLY|O_NONBLOCK,<span class="number">0</span>))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"打开FIFO失败"</span>);</span><br><span class="line">        unlink(FIFO);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((n=read(fd,buf,BUFFSIZE))&gt;<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d Bytes Read From FIFO:  %s n"</span>,n,buf);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (n==<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"当前FIFO是空的.n"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            perror(<span class="string">"从FIFO读取失败n"</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (close(fd)==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"关闭FIFO失败"</span>);</span><br><span class="line">        unlink(FIFO);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(FIFO);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fifo_write.c:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_MODE  (S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO <span class="meta-string">"myfifo"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFSIZE 128</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">size_t</span> n;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFFSIZE] = <span class="string">"This is a IPC Message"</span>;</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(FIFO,O_WRONLY|O_NONBLOCK,<span class="number">0</span>))==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_sys(<span class="string">"打开FIFO失败"</span>);</span><br><span class="line">        unlink(FIFO);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((n=write(fd,buf,BUFFSIZE))&gt;<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d Bytes Write To FIFO : %s n"</span>,n,buf);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            err_sys(<span class="string">"不能写FIFOn"</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (close(fd)==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_sys(<span class="string">"关闭FIFO失败"</span>);</span><br><span class="line">        unlink(FIFO);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    unlink(FIFO);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2011/10/12/2011/2011-10-12-hdu1116/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/12/2011/2011-10-12-hdu1116/" itemprop="url">HDU 1116 Play on Words</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-12T02:59:25+00:00">
                2011-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/文章归档/" itemprop="url" rel="index">
                    <span itemprop="name">文章归档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2011/10/12/2011/2011-10-12-hdu1116/" class="leancloud_visitors" data-flag-title="HDU 1116 Play on Words">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Step1:根据一个单词的首尾字符建立有向图，记录出度和入度。</p>
<p>Step2:使用并查集判断是否连通(就是查找计数公共祖先数目)</p>
<p>Step3:判断Euler通路(回路)</p>
<p>如果是一个Euler回路，那么所有的顶点出度等于入度。</p>
<p>如果判断一个Euler通路，就要找：</p>
<p>一个起始点（出度-入度=1）的顶点</p>
<p>一个终点（入度-出度=1）的顶点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST printf(<span class="meta-string">"Here Is Ok\n"</span>);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">enum</span> boolean&#123;<span class="literal">false</span>,<span class="literal">true</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX(x,y) ((x)&gt;(y)?(x):(y))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN(x,y) ((x)&lt;(y)?(x):(</span></span><br><span class="line"><span class="keyword">int</span> in[<span class="number">26</span>],out[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">int</span> app[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">int</span> pre[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">int</span> io[<span class="number">2</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pre[x]!=x)</span><br><span class="line">        pre[x] = find(pre[x]);</span><br><span class="line">    <span class="keyword">return</span> pre[x];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unionSet</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x,y;</span><br><span class="line">    x = find(a);</span><br><span class="line">    y = find(b);</span><br><span class="line">    <span class="keyword">if</span> (x!=y)</span><br><span class="line">        pre[x] = y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//并查集查祖先节点</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">countRoot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (app[i] &amp;&amp; find(i)==i)</span><br><span class="line">            cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    freopen(<span class="string">"in.txt"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">int</span> T,n;</span><br><span class="line">    <span class="keyword">char</span> a,b,c;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">int</span> i,k;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">    <span class="keyword">while</span> (T--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) pre[i] = i;</span><br><span class="line">        <span class="built_in">memset</span>(in,<span class="number">0</span>,<span class="keyword">sizeof</span>(in));</span><br><span class="line">        <span class="built_in">memset</span>(out,<span class="number">0</span>,<span class="keyword">sizeof</span>(out));</span><br><span class="line">        <span class="built_in">memset</span>(app,<span class="number">0</span>,<span class="keyword">sizeof</span>(app));</span><br><span class="line">        <span class="keyword">while</span> (n--)</span><br><span class="line">        &#123;</span><br><span class="line">            a = getchar();</span><br><span class="line">            a-=<span class="string">'a'</span>;</span><br><span class="line">            out[a]++;</span><br><span class="line">            <span class="keyword">while</span> (b = c,(c = getchar())!=<span class="string">'\n'</span>);</span><br><span class="line">            b-=<span class="string">'a'</span>;</span><br><span class="line">            in[b]++;</span><br><span class="line">            app[a] = app[b] = <span class="literal">true</span>;</span><br><span class="line">            unionSet(a,b);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (countRoot()&gt;<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"The door cannot be opened."</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>,k = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (app[i] &amp;&amp; out[i]!=in[i])</span><br><span class="line">                io[k++] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Euler回路</span></span><br><span class="line">        <span class="keyword">if</span> (k==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Ordering is possible."</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Euler通路</span></span><br><span class="line">            <span class="keyword">if</span> (k==<span class="number">2</span> &amp;&amp;(out[io[<span class="number">0</span>]]-in[io[<span class="number">0</span>]]==<span class="number">1</span> &amp;&amp; in[io[<span class="number">1</span>]]-out[io[<span class="number">1</span>]]==<span class="number">1</span> ||out[io[<span class="number">1</span>]]-in[io[<span class="number">1</span>]]==<span class="number">1</span> &amp;&amp;in0]]-out[io[<span class="number">0</span>]]==<span class="number">1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Ordering is possible."</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"The door cannot be opened."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    getch();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2011/10/03/2011/2011-10-03-hdu1556/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/03/2011/2011-10-03-hdu1556/" itemprop="url">HDU 1556 Color the ball</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-03T04:44:54+00:00">
                2011-10-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/文章归档/" itemprop="url" rel="index">
                    <span itemprop="name">文章归档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2011/10/03/2011/2011-10-03-hdu1556/" class="leancloud_visitors" data-flag-title="HDU 1556 Color the ball">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>简单难度的线段树，题意是给定编号1…N的N个球，然后给定数据对区间[a,b]上的球进行染色一次，最后要求输出每个球被染色的次数。先建立线段树，然后对每个操作区间[a,b]上的次数在树上进行维护，最后遍历一次统计出次数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Maxn 100001</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> LEFT;</span><br><span class="line">    <span class="keyword">int</span> RIGHT;</span><br><span class="line">    <span class="keyword">int</span> nCount;</span><br><span class="line">&#125;TREE[Maxn*<span class="number">3</span>];</span><br><span class="line"><span class="keyword">int</span> Total[Maxn];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BUILD</span><span class="params">(<span class="keyword">int</span> r,<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TREE[r].LEFT = a;</span><br><span class="line">    TREE[r].RIGHT = b;</span><br><span class="line">    TREE[r].nCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> MID;</span><br><span class="line">    <span class="keyword">if</span>(a==b)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    MID = (a+b)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">    BUILD(r&lt;&lt;<span class="number">1</span>,a,MID);</span><br><span class="line">    BUILD((r&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>,MID+<span class="number">1</span>,b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UPDATA</span><span class="params">(<span class="keyword">int</span> r,<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> MID;</span><br><span class="line">    <span class="keyword">if</span>(a==TREE[r].LEFT &amp;&amp; b==TREE[r].RIGHT)</span><br><span class="line">        TREE[r].nCount++;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        MID = (TREE[r].LEFT+TREE[r].RIGHT)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(b &lt;= MID)</span><br><span class="line">            UPDATA(r&lt;&lt;<span class="number">1</span>,a,b);</span><br><span class="line">        elseif( a &gt; MID)</span><br><span class="line">            UPDATA((r&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>,a,b);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            UPDATA(r&lt;&lt;<span class="number">1</span>,a,MID);</span><br><span class="line">            UPDATA((r&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>,MID+<span class="number">1</span>,b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SUM</span><span class="params">(<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = TREE[r].LEFT; i &lt;= TREE[r].RIGHT;i++)</span><br><span class="line">        Total[i]+=TREE[r].nCount;</span><br><span class="line">    <span class="keyword">if</span>(TREE[r].LEFT==TREE[r].RIGHT)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        SUM(r&lt;&lt;<span class="number">1</span>);</span><br><span class="line">        SUM((r&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    freopen(<span class="string">"Sample Input.txt"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">int</span> N;</span><br><span class="line">    <span class="keyword">int</span> i,j,a,b;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;N),N)</span><br><span class="line">    &#123;</span><br><span class="line">        BUILD(<span class="number">1</span>,<span class="number">1</span>,N);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;a,&amp;b);</span><br><span class="line">            UPDATA(<span class="number">1</span>,a,b);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(Total,<span class="number">0</span>,<span class="keyword">sizeof</span>(Total));</span><br><span class="line">        SUM(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(i==<span class="number">1</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d"</span>,Total[i]);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">" %d"</span>,Total[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    getch();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2011/10/02/2011/2011-10-02-hdu2851/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/02/2011/2011-10-02-hdu2851/" itemprop="url">HDU 2851 Lode Runner</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-02T10:18:35+00:00">
                2011-10-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/文章归档/" itemprop="url" rel="index">
                    <span itemprop="name">文章归档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2011/10/02/2011/2011-10-02-hdu2851/" class="leancloud_visitors" data-flag-title="HDU 2851 Lode Runner">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转化为图后求最短路径。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IF road[i].x2 &gt;= road[j].x1 &amp;&amp; road[i].x2 &lt;= road[j].x2 THEN</span><br><span class="line">    建立一条边</span><br></pre></td></tr></table></figure>
<p>然后由DIJKSTRA对求顶点1到其他边的最短路径</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Maxn 2001</span></span><br><span class="line"><span class="keyword">int</span> mat[Maxn][Maxn];</span><br><span class="line"><span class="keyword">int</span> M,N;</span><br><span class="line"><span class="keyword">int</span> dist[Maxn];</span><br><span class="line"><span class="keyword">int</span> used[Maxn];</span><br><span class="line"><span class="keyword">enum</span> boolean &#123;FALSE,TRUE&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> inf = <span class="number">0x0fffffff</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> x1;</span><br><span class="line">    <span class="keyword">int</span> x2;</span><br><span class="line">    <span class="keyword">int</span> w;</span><br><span class="line">&#125;road[Maxn];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DIJSTRA</span><span class="params">(<span class="keyword">int</span> s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,k;</span><br><span class="line">    <span class="keyword">int</span> min;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        dist[i] = mat[s][i];</span><br><span class="line">        used[i] = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    used[s] = TRUE;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; N; i++)</span><br><span class="line">        &#123;</span><br><span class="line">        min = inf;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= N; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[j]==FALSE &amp;&amp; dist[j] &lt; min)</span><br><span class="line">            &#123;</span><br><span class="line">                min = dist[j];</span><br><span class="line">                k = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        used[k] = TRUE;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= N; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[j]==FALSE &amp;&amp; dist[j] &gt; dist[k]+mat[k][j])</span><br><span class="line">                dist[j] = dist[k]+mat[k][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> T;</span><br><span class="line">    <span class="keyword">int</span> i,j,k;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T);</span><br><span class="line">    <span class="keyword">while</span> (T--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;N,&amp;M);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= N; j++)</span><br><span class="line">                mat[i][j] = inf;</span><br><span class="line">            mat[i][i] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;road[i].x1,&amp;road[i].x2,&amp;road[i].w);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= N; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = i+<span class="number">1</span>; j &lt;= N; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (road[i].x2 &gt;= road[j].x1 &amp;&amp; road[i].x2 &lt;= road[j].x2)</span><br><span class="line">                    mat[i][j] = road[j].w;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        DIJSTRA(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= M; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;k);</span><br><span class="line">            <span class="keyword">if</span> (dist[k]&lt;inf)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,road[<span class="number">1</span>].w+dist[k]);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-1\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://sizeoftank.github.io/2011/09/30/2011/2011-09-30-hdu2852/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sizeoftank">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sizeoftank">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/30/2011/2011-09-30-hdu2852/" itemprop="url">HDU 2852 KiKi's K-Number</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-30T20:46:20+00:00">
                2011-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/文章归档/" itemprop="url" rel="index">
                    <span itemprop="name">文章归档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2011/09/30/2011/2011-09-30-hdu2852/" class="leancloud_visitors" data-flag-title="HDU 2852 KiKi's K-Number">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>题目描述一个容器有三种操作，压入a，删除a，查询容器中比a大的第k个数。</p>
<p>利用树状数组快速求前n项和修改元素的性质。</p>
<p>对于插入和删除操作都是从a处开始简单更新树状数组+1或者-1</p>
<p>查询的时候利用sum（x）快速求出比x小的有多少个的性质，因为sum(x)的值是在[0,Maxm]都是单调递增的，因此可以从区间[a,Maxm]进行二分查找，找出比a大的第k个数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Maxn 300005</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Maxm 100005</span></span><br><span class="line"><span class="keyword">enum</span> boolean&#123;FALSE,TRUE&#125;;</span><br><span class="line"><span class="keyword">int</span> A[Maxm];</span><br><span class="line"><span class="keyword">int</span> C[Maxn];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lowbit</span><span class="params">(<span class="keyword">int</span> t)</span></span>&#123; <span class="keyword">return</span> -t &amp; t;&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">plus</span><span class="params">(<span class="keyword">int</span> pos,<span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (pos&lt;Maxn)</span><br><span class="line">    &#123;</span><br><span class="line">        C[pos]+=num;</span><br><span class="line">        pos+=lowbit(pos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (end&gt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sum += C[end];</span><br><span class="line">        end -= lowbit(end);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mid,low,high;</span><br><span class="line">    <span class="keyword">int</span> i,j,t;</span><br><span class="line">    <span class="keyword">if</span>(sum(Maxm)-sum(a)&lt;k)   <span class="comment">//判断是否可能存在</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    i = sum(a);               <span class="comment">//记录容器中比a小的数的个数</span></span><br><span class="line">    low = a;</span><br><span class="line">    high = Maxm;</span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high)       <span class="comment">//二分找到第k大</span></span><br><span class="line">    &#123;</span><br><span class="line">        mid = (low+high)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        t = sum(mid);</span><br><span class="line">        <span class="keyword">if</span> (A[mid] &amp;&amp; t-A[mid]&lt;k+i &amp;&amp; t-i&gt;=k)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (t &lt; k+i)</span><br><span class="line">            low = mid+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            high = mid<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,mid);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> T,i,a,k,s;</span><br><span class="line">    freopen(<span class="string">"Sample Input.txt"</span>,<span class="string">"r"</span>,<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;T)!=EOF)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(C,<span class="number">0</span>,<span class="keyword">sizeof</span>(C));</span><br><span class="line">        <span class="built_in">memset</span>(A,<span class="number">0</span>,<span class="keyword">sizeof</span>(A));</span><br><span class="line">        <span class="keyword">while</span>(T--)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;s);</span><br><span class="line">            <span class="keyword">if</span> (!s)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a);</span><br><span class="line">                plus(a,<span class="number">1</span>);</span><br><span class="line">                A[a]++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (s==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a);</span><br><span class="line">                <span class="keyword">if</span> (A[a] &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"No Elment!\n"</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    plus(a,<span class="number">-1</span>);</span><br><span class="line">                    A[a]--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;a,&amp;k);</span><br><span class="line">                <span class="keyword">if</span> (!query(a,k))</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Not Find!\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    getch();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">sizeoftank</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sizeoftank" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/lovefar/" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-globe"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sizeoftank</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>





  <script src="https://unpkg.com/mermaid@8.13.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"forest"});
    }
  </script>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("tclzHvBInNDh45LdDgB99dS3-gzGzoHsz", "egATB3l5I1ctiULajrBzgABl");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
